name: Discord Notify
on:
  push:
    branches:
      - main
jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get commit details from GitHub API
        id: commit
        run: |
          api_url="https://api.github.com/repos/${{ github.repository }}/commits/${{ github.sha }}"
          response=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$api_url")

          echo "message=$(echo "$response" | jq -r '.commit.message')" >> $GITHUB_OUTPUT
          echo "added=$(echo "$response" | jq '[.files[] | select(.status=="added")] | length')" >> $GITHUB_OUTPUT
          echo "removed=$(echo "$response" | jq '[.files[] | select(.status=="removed")] | length')" >> $GITHUB_OUTPUT
          echo "modified=$(echo "$response" | jq '[.files[] | select(.status=="modified")] | length')" >> $GITHUB_OUTPUT
          echo "additions=$(echo "$response" | jq '.stats.additions')" >> $GITHUB_OUTPUT
          echo "deletions=$(echo "$response" | jq '.stats.deletions')" >> $GITHUB_OUTPUT
      - name: Send Discord notification
        run: |
          cat <<EOF > payload.json
          {
            "content": "**ğŸš€ GitHub Push Event**\n\nğŸ”€ **Branch:** ${{ github.ref_name }}\nğŸ‘¤ **Author:** ${{ github.actor }}\nğŸ“¦ **Repo:** ${{ github.repository }}\nğŸ“ **Commit:** ${{ steps.commit.outputs.message }}\n\nğŸ“Š **LoC:** +${{ steps.commit.outputs.additions }}  -${{ steps.commit.outputs.deletions }}\nğŸ“ **Files:** â• ${{ steps.commit.outputs.added }}  â– ${{ steps.commit.outputs.removed }}  âœï¸ ${{ steps.commit.outputs.modified }}"
          }
          EOF

          curl -X POST \
            -H "Content-Type: application/json" \
            --data @payload.json \
            ${{ secrets.DISCORD_WEBHOOK }}

